name: Bottle

on:
  pull_request:
    paths:
      - 'Formula/*.rb'
  push:
    branches: [ main ]
    paths:
      - 'Formula/*.rb'
  workflow_dispatch:
    inputs:
      formula:
        description: 'Formula to test (default: mfc)'
        required: false
        default: 'mfc'

permissions:
  contents: write

jobs:
  test-bot:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, macos-13]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master
        with:
          test-bot: false
      
      - name: Build and test (PR)
        if: github.event_name == 'pull_request'
        run: |
          brew test-bot --only-formulae --tap=$GITHUB_REPOSITORY mfc
      
      - name: Build and test (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          FORMULA="${{ github.event.inputs.formula }}"
          if [ -z "$FORMULA" ]; then FORMULA="mfc"; fi
          echo "Testing formula: $FORMULA"
          brew test-bot --only-formulae --tap=$GITHUB_REPOSITORY $FORMULA
      
      - name: Build, bottle, and publish (push to main)
        if: github.event_name == 'push'
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          brew test-bot --only-formulae --tap=$GITHUB_REPOSITORY --publish mfc
      
      - name: Cleanup tap symlink
        if: always()
        continue-on-error: true
        run: |
          # Remove the tap symlink/directory that setup-homebrew creates
          # The setup-homebrew action creates a symlink that its cleanup script can't handle
          if [ -L "/opt/homebrew/Library/Taps/mflowcode/homebrew-mfc" ] || [ -d "/opt/homebrew/Library/Taps/mflowcode/homebrew-mfc" ]; then
            brew untap "$GITHUB_REPOSITORY" 2>/dev/null || true
            rm -rf "/opt/homebrew/Library/Taps/mflowcode/homebrew-mfc" 2>/dev/null || true
          fi
          # Touch a marker file so post-cleanup knows we handled it
          mkdir -p /tmp
          touch /tmp/homebrew-tap-cleaned

  verify-install:
    runs-on: macos-latest
    if: github.event_name != 'workflow_dispatch'  # Skip for manual runs
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master
        with:
          test-bot: false
      
      - name: Tap and install
        run: |
          brew untap "$GITHUB_REPOSITORY" || true
          brew tap "$GITHUB_REPOSITORY"
          brew uninstall --force mfc || true
          for i in {1..6}; do
            if brew install MFlowCode/mfc/mfc; then break; fi
            echo "Retrying in 20s (attempt $i/6) ..." && sleep 20
          done
          brew test MFlowCode/mfc/mfc || mfc --help
      
      - name: Cleanup tap
        if: always()
        continue-on-error: true
        run: |
          # Properly cleanup the tap to avoid post-job errors
          if [ -L "/opt/homebrew/Library/Taps/mflowcode/homebrew-mfc" ] || [ -d "/opt/homebrew/Library/Taps/mflowcode/homebrew-mfc" ]; then
            brew untap "$GITHUB_REPOSITORY" 2>/dev/null || true
            rm -rf "/opt/homebrew/Library/Taps/mflowcode/homebrew-mfc" 2>/dev/null || true
          fi
